import Node, { addNodeClass } from '../core/Node.js';
<<<<<<< HEAD
import { bufferAttribute, dynamicBufferAttribute } from './BufferAttributeNode.js';
import { normalLocal } from './NormalNode.js';
import { positionLocal } from './PositionNode.js';
import { nodeProxy, vec3, mat3, mat4 } from '../shadernode/ShaderNode.js';
import { DynamicDrawUsage } from 'three';
=======
import { instanceIndex } from '../core/InstanceIndexNode.js';
import { temp } from '../core/VarNode.js';
import { buffer } from './BufferNode.js';
import { normalLocal } from './NormalNode.js';
import { positionLocal } from './PositionNode.js';
import { nodeProxy, vec3, mat3 } from '../shadernode/ShaderNode.js';
>>>>>>> 39788b5e01a4817c1ea46a2f2383841e87dacb23

class InstanceNode extends Node {

	constructor( instanceMesh ) {

		super( 'void' );

		this.instanceMesh = instanceMesh;

<<<<<<< HEAD
		this.instanceMatrixNode = null;

	}

	construct( builder ) {

		let instanceMatrixNode = this.instanceMatrixNode;

		if ( instanceMatrixNode === null ) {

			const instanceMesh = this.instanceMesh;
			const instaceAttribute = instanceMesh.instanceMatrix;
			const array = instaceAttribute.array;

			const bufferFn = instaceAttribute.usage === DynamicDrawUsage ? dynamicBufferAttribute : bufferAttribute;

			const instanceBuffers = [
				// F.Signature -> bufferAttribute( array, type, stride, offset )
				bufferFn( array, 'vec4', 16, 0 ),
				bufferFn( array, 'vec4', 16, 4 ),
				bufferFn( array, 'vec4', 16, 8 ),
				bufferFn( array, 'vec4', 16, 12 )
			];

			instanceMatrixNode = mat4( ...instanceBuffers );

			this.instanceMatrixNode = instanceMatrixNode;

		}
=======
		//

		const instanceBufferNode = buffer( instanceMesh.instanceMatrix.array, 'mat4', instanceMesh.count );

		this.instanceMatrixNode = temp( instanceBufferNode.element( instanceIndex ) ); // @TODO: a possible caching issue here?

	}

	generate( builder ) {

		const { instanceMatrixNode } = this;
>>>>>>> 39788b5e01a4817c1ea46a2f2383841e87dacb23

		// POSITION

		const instancePosition = instanceMatrixNode.mul( positionLocal ).xyz;

		// NORMAL

		const m = mat3( instanceMatrixNode[ 0 ].xyz, instanceMatrixNode[ 1 ].xyz, instanceMatrixNode[ 2 ].xyz );

		const transformedNormal = normalLocal.div( vec3( m[ 0 ].dot( m[ 0 ] ), m[ 1 ].dot( m[ 1 ] ), m[ 2 ].dot( m[ 2 ] ) ) );

		const instanceNormal = m.mul( transformedNormal ).xyz;

		// ASSIGNS

<<<<<<< HEAD
		builder.stack.assign( positionLocal, instancePosition );
		builder.stack.assign( normalLocal, instanceNormal );

		return builder.stack;
=======
		positionLocal.assign( instancePosition ).build( builder );
		normalLocal.assign( instanceNormal ).build( builder );
>>>>>>> 39788b5e01a4817c1ea46a2f2383841e87dacb23

	}

}

export default InstanceNode;

export const instance = nodeProxy( InstanceNode );

addNodeClass( InstanceNode );
